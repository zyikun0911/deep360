# 🚀 Deep360 服务器部署指南

## 📋 部署信息

- **服务器 IP**: 74.208.61.148
- **服务器路径**: /opt/messenger360/
- **GitHub 仓库**: https://github.com/zyikun0911/deep360

## 🎯 部署方式

### 方式一：自动部署（推荐）

运行自动化部署脚本：

```powershell
powershell -ExecutionPolicy Bypass -File deploy-to-server.ps1
```

### 方式二：手动部署

#### 1. 创建部署包

```powershell
# 创建部署目录
mkdir deploy-package
cd deploy-package

# 复制必要文件
Copy-Item ..\package.json .
Copy-Item ..\server.js .
Copy-Item ..\start.js .
Copy-Item ..\healthcheck.js .
Copy-Item ..\Dockerfile .
Copy-Item ..\docker-compose.yml .
Copy-Item ..\env.example .

# 复制目录
Copy-Item ..\routes . -Recurse
Copy-Item ..\services . -Recurse
Copy-Item ..\models . -Recurse
Copy-Item ..\middleware . -Recurse
Copy-Item ..\utils . -Recurse
Copy-Item ..\plugins . -Recurse
Copy-Item ..\frontend . -Recurse
Copy-Item ..\scripts . -Recurse
Copy-Item ..\config . -Recurse

# 创建压缩包
Compress-Archive -Path * -DestinationPath ..\deep360-deploy.zip
```

#### 2. 上传到服务器

```bash
# 上传文件
scp deep360-deploy.zip root@74.208.61.148:/tmp/

# 登录服务器
ssh root@74.208.61.148
```

#### 3. 在服务器上部署

```bash
# 进入临时目录
cd /tmp

# 解压文件
unzip deep360-deploy.zip -d deep360-deploy/
cd deep360-deploy

# 创建备份
BACKUP_DIR="/root/backup_$(date +%Y%m%d_%H%M%S)"
mkdir -p $BACKUP_DIR
if [ -d "/opt/messenger360" ]; then
    cp -r /opt/messenger360 $BACKUP_DIR/
fi

# 停止现有服务
pm2 stop all || true
systemctl stop nginx || true

# 部署新代码
rm -rf /opt/messenger360/*
cp -r * /opt/messenger360/
cd /opt/messenger360

# 安装依赖
npm install --production

# 构建前端
cd frontend
npm install
npm run build
cd ..

# 配置环境变量
if [ ! -f ".env" ]; then
    cp env.example .env
fi

# 启动服务
pm2 start server.js --name deep360-api
pm2 save

# 启动 Nginx
systemctl start nginx

# 健康检查
sleep 5
curl -f http://localhost:7788/health || echo "⚠️ 健康检查失败"

echo "✅ 部署完成！"
echo "🌐 访问地址: http://74.208.61.148"
```

## 🔧 部署配置

### 环境变量配置

创建 `.env` 文件：

```env
# 应用配置
NODE_ENV=production
PORT=7788

# 数据库配置
MONGODB_URI=mongodb://localhost:27017/deep360
REDIS_URL=redis://localhost:6379

# JWT 配置
JWT_SECRET=your-production-jwt-secret

# 其他配置...
```

### PM2 配置

创建 `ecosystem.config.js`：

```javascript
module.exports = {
  apps: [{
    name: 'deep360-api',
    script: 'server.js',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G',
    env: {
      NODE_ENV: 'production',
      PORT: 7788
    }
  }]
};
```

### Nginx 配置

```nginx
server {
    listen 80;
    server_name 74.208.61.148;
    
    # 前端静态文件
    location / {
        root /opt/messenger360/frontend/dist;
        try_files $uri $uri/ /index.html;
    }
    
    # API 代理
    location /api/ {
        proxy_pass http://localhost:7788/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
    
    # WebSocket 代理
    location /socket.io/ {
        proxy_pass http://localhost:7788;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
    }
}
```

## 📊 部署验证

### 1. 检查服务状态

```bash
# 检查 PM2 进程
pm2 list

# 检查端口
netstat -tlnp | grep :7788

# 检查 Nginx
systemctl status nginx
```

### 2. 健康检查

```bash
# API 健康检查
curl http://localhost:7788/health

# 前端访问
curl http://localhost:80
```

### 3. 日志检查

```bash
# PM2 日志
pm2 logs deep360-api

# Nginx 日志
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log
```

## 🛡️ 安全配置

### 1. 防火墙配置

```bash
# 开放必要端口
ufw allow 80
ufw allow 443
ufw allow 22
ufw enable
```

### 2. SSL 证书（可选）

```bash
# 安装 Certbot
apt install certbot python3-certbot-nginx

# 获取 SSL 证书
certbot --nginx -d your-domain.com
```

## 🔄 更新部署

### 自动更新

```bash
# 从 GitHub 拉取最新代码
cd /opt/messenger360
git pull origin main

# 重启服务
pm2 restart deep360-api
```

### 手动更新

```bash
# 停止服务
pm2 stop deep360-api

# 更新代码
# ... 复制新文件 ...

# 安装依赖
npm install --production

# 构建前端
cd frontend && npm run build && cd ..

# 重启服务
pm2 start deep360-api
```

## 📞 故障排除

### 常见问题

1. **端口被占用**
   ```bash
   lsof -i :7788
   kill -9 <PID>
   ```

2. **权限问题**
   ```bash
   chown -R www-data:www-data /opt/messenger360
   chmod -R 755 /opt/messenger360
   ```

3. **内存不足**
   ```bash
   # 增加 swap
   fallocate -l 2G /swapfile
   chmod 600 /swapfile
   mkswap /swapfile
   swapon /swapfile
   ```

4. **数据库连接失败**
   ```bash
   # 检查 MongoDB
   systemctl status mongod
   
   # 检查 Redis
   systemctl status redis
   ```

## 🎉 部署完成

部署成功后，您可以访问：

- **前端界面**: http://74.208.61.148
- **API 文档**: http://74.208.61.148/api/docs
- **健康检查**: http://74.208.61.148/health

---

**🚀 Deep360 系统已成功部署到服务器！**
