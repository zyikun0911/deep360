# 🚀 Deep360 GitHub Webhook 完整部署步骤

## 📋 部署信息
- **服务器 IP**: 74.208.61.148
- **GitHub 仓库**: zyikun0911/deep360
- **Webhook 密钥**: deep360-secret-1234

## 🔧 步骤 1: 手动上传配置文件

在您的终端中依次执行以下命令：

```bash
# 上传 Webhook 服务器文件
scp webhook-server.js root@74.208.61.148:/opt/messenger360/

# 上传 Webhook 接收器脚本
scp webhook-receiver.sh root@74.208.61.148:/opt/messenger360/

# 上传 Nginx 配置文件
scp nginx-deep360.conf root@74.208.61.148:/etc/nginx/sites-available/deep360
```

## 🔧 步骤 2: 登录服务器配置

```bash
# 登录服务器
ssh root@74.208.61.148

# 进入项目目录
cd /opt/messenger360

# 设置脚本权限
chmod +x webhook-receiver.sh

# 创建日志目录
mkdir -p /var/log
touch /var/log/deep360-webhook.log
chmod 666 /var/log/deep360-webhook.log

# 配置 Nginx
ln -sf /etc/nginx/sites-available/deep360 /etc/nginx/sites-enabled/
nginx -t
systemctl reload nginx

# 启动 Webhook 服务器
pm2 start webhook-server.js --name deep360-webhook
pm2 save

# 检查服务状态
pm2 list
```

## 🔧 步骤 3: 配置 GitHub Webhook

1. **访问 GitHub 仓库设置**:
   - 打开浏览器访问: https://github.com/zyikun0911/deep360/settings/hooks
   - 点击 "Add webhook" 按钮

2. **配置 Webhook 参数**:
   - **Payload URL**: `http://74.208.61.148/webhook`
   - **Content type**: `application/json`
   - **Secret**: `deep360-secret-1234`
   - **Events**: 选择 "Just the push event"
   - 点击 "Add webhook"

## 🔧 步骤 4: 测试自动部署

```bash
# 推送测试代码
git add .
git commit -m "测试自动部署"
git push origin main

# 查看部署日志
ssh root@74.208.61.148 "tail -f /var/log/deep360-webhook.log"
```

## 📊 监控命令

```bash
# 查看 Webhook 日志
ssh root@74.208.61.148 "tail -f /var/log/deep360-webhook.log"

# 检查服务状态
ssh root@74.208.61.148 "pm2 status"

# 健康检查
ssh root@74.208.61.148 "curl -f http://localhost:7788/health"
```

## 🎯 一键执行脚本

如果您想一次性执行所有服务器配置命令，可以复制以下内容到服务器：

```bash
#!/bin/bash
# 进入项目目录
cd /opt/messenger360

# 设置脚本权限
chmod +x webhook-receiver.sh

# 创建日志目录
mkdir -p /var/log
touch /var/log/deep360-webhook.log
chmod 666 /var/log/deep360-webhook.log

# 配置 Nginx
ln -sf /etc/nginx/sites-available/deep360 /etc/nginx/sites-enabled/
nginx -t && systemctl reload nginx

# 启动 Webhook 服务器
pm2 start webhook-server.js --name deep360-webhook
pm2 save

# 检查服务状态
pm2 list

echo "✅ 服务器配置完成！"
```

## 🎉 完成！

部署完成后，当您推送代码到 GitHub 时，服务器会自动：

1. **接收 Webhook 通知** - GitHub 发送推送事件
2. **验证请求安全性** - 使用 HMAC-SHA256 签名验证
3. **拉取最新代码** - 从 GitHub 自动拉取
4. **重新构建应用** - 安装依赖并构建前端
5. **重启服务** - 使用 PM2 重启应用
6. **验证部署成功** - 健康检查确认服务正常

**现在您可以享受完全自动化的开发部署流程！** 🚀

## 📞 故障排除

如果遇到问题，请检查：

1. **SSH 连接**: 确保可以正常连接服务器
2. **文件权限**: 确保 webhook-receiver.sh 有执行权限
3. **服务状态**: 使用 `pm2 status` 检查服务状态
4. **日志查看**: 使用 `tail -f /var/log/deep360-webhook.log` 查看详细日志
5. **Nginx 配置**: 使用 `nginx -t` 检查配置语法
